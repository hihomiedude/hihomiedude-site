<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>hihomiedude</title>
    <link rel="icon" type="image/png" href="assets/images/LULW.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-bottom: 60px; /* Space for footer */
            position: relative;
            transition: background-color 0.3s ease-out;
        }
        
        .header {
            padding: 10px 20px;
            margin-bottom: 10px;
            background-color: #2d2d2d;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: normal;
        }
        
        /* Song info below header */
        .song-info {
            background-color: #2d2d2d;
            border: 2px solid #555;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
            position: relative;
        }
        
        .progress-container {
            position: relative;
            width: 100%;
            height: 20px;
            margin-top: 10px;
        }
        
        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #555;
            transform: translateY(-50%);
        }
        
        .progress-dot {
            position: absolute;
            top: 50%;
            left: 0%;
            width: 12px;
            height: 12px;
            background-color: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: left 0.1s linear;
        }
        
        #visualizer {
            display: block;
            margin: 15px auto 5px;
            background-color: #1a1a1a;
            border: 1px solid #444;
            max-width: 100%;
            height: auto;
        }
        
        .main-container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }
        
        .side-image {
            padding: 10px;
            background-color: #2d2d2d;
            min-width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 30px;
            overflow: visible;
            transition: background-color 0.05s ease-out, transform 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .lulw-img {
            width: 100px;
            height: 100px;
            display: block;
        }
        
        .dancing-img {
            width: 100px;
            height: 100px;
            display: none;
        }
        
        .dancing-img.show {
            display: block;
        }
        
        
        .center-box {
            background-color: #2d2d2d;
            padding: 30px;
            flex: 1;
            min-height: 400px;
            text-align: center;
        }
        
        .link-item {
            margin: 40px 0;
            font-size: 18px;
        }
        
        .link-item a {
            color: #ffffff;
            text-decoration: none;
            border: 2px solid #555;
            padding: 8px 15px;
            background-color: #333;
            display: inline-block;
            transition: none;
        }
        
        .link-item a:hover {
            background-color: #444;
            border-color: #777;
        }
        
        .twitch-link {
            color: #9146ff !important;
        }
        
        .discord-link {
            color: #5865f2 !important;
        }
        
        .anime-link {
            color: #ff69b4 !important;
        }
        
        .tone-link {
            color: #ffd93d !important;
        }
        
        .audio-controls {
            margin-top: 20px;
        }
        
        .play-section {
            text-align: center;
            font-family: 'Courier New', monospace;
            margin-bottom: 15px;
        }
        
        .play-prompt {
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
        }
        
        .play-button-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mute-button {
            background-color: #2d2d2d;
            color: white;
            border: 2px solid #444;
            padding: 12px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            font-size: 16px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .mute-button:hover {
            background-color: #333;
            border-color: #666;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4);
        }
        
        .mute-button::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: rgba(0,0,0,0.2);
            pointer-events: none;
        }
        
        .rainbow-text {
            background: linear-gradient(90deg, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff00, #00ff80, #00ffff, #4da6ff, 
                #6699ff, #b366ff, #ff00ff, #ff0080, 
                #ff0000);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-cycle 3s linear infinite;
        }
        
        @keyframes rainbow-cycle {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }
        
        @keyframes bass-thump-up {
            0% {
                transform: scale(1) translateY(0);
                filter: brightness(1);
            }
            50% {
                transform: scale(2.0) translateY(-20px);
                filter: brightness(1.2);
            }
            100% {
                transform: scale(1) translateY(0);
                filter: brightness(1);
            }
        }
        
        @keyframes bass-thump-down {
            0% {
                transform: scale(1) translateY(0);
                filter: brightness(1);
            }
            50% {
                transform: scale(2.0) translateY(20px);
                filter: brightness(1.2);
            }
            100% {
                transform: scale(1) translateY(0);
                filter: brightness(1);
            }
        }
        
        /* Mobile-specific thump animations with less movement */
        @media (max-width: 768px) {
            @keyframes bass-thump-up {
                0% {
                    transform: scale(1) translateY(0);
                    filter: brightness(1);
                }
                50% {
                    transform: scale(1.5) translateY(-8px);
                    filter: brightness(1.2);
                }
                100% {
                    transform: scale(1) translateY(0);
                    filter: brightness(1);
                }
            }
            
            @keyframes bass-thump-down {
                0% {
                    transform: scale(1) translateY(0);
                    filter: brightness(1);
                }
                50% {
                    transform: scale(1.5) translateY(8px);
                    filter: brightness(1.2);
                }
                100% {
                    transform: scale(1) translateY(0);
                    filter: brightness(1);
                }
            }
        }
        
        .thump-up {
            animation: bass-thump-up 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .thump-down {
            animation: bass-thump-down 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .side-image-thump {
            animation: side-box-thump 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes side-box-thump {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }
        
        @media (max-width: 768px) {
            @keyframes side-box-thump {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.2);
                }
                100% {
                    transform: scale(1);
                }
            }
        }
        
        .audio-controls {
            margin-top: 0;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .side-image:first-child {
                display: block;
                order: -1;
            }
            
            .side-image:last-child {
                display: none;
            }
            
            .side-image {
                padding: 8px;
                min-width: auto;
                gap: 10px;
                overflow: hidden; /* Prevent clipping */
            }
            
            .lulw-img {
                width: 80px;
                height: 80px;
                margin-bottom: 15px;
            }
            
            .dancing-img {
                width: 80px;
                height: 80px;
            }
            
            .center-box {
                padding: 20px;
                min-height: auto;
                width: 100%;
                max-width: 280px;
            }
            
            .link-item {
                margin: 20px 0;
            }
            
            .header {
                margin-bottom: 8px;
                padding: 8px 15px;
            }
            
            body {
                font-size: 14px;
                padding: 10px;
            }
            
            .song-info {
                padding: 8px;
                font-size: 12px;
                margin-bottom: 15px;
            }
        }
        
        .footer {
            margin-top: auto;
            text-align: center;
            font-size: 10px;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            border: 1px solid #444;
            padding: 5px 10px;
            background-color: #2d2d2d;
            margin-bottom: 20px;
        }
        
        .seizure-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-family: 'Courier New', monospace;
            font-size: 48px;
            font-weight: bold;
            color: #ffffff;
            text-align: center;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.75);
            border: 5px solid #ffffff;
            box-sizing: border-box;
            display: none;
            cursor: pointer;
        }
        
        .seizure-warning-small {
            font-size: 16px;
            font-weight: normal;
            margin-top: 10px;
            color: #cccccc;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .seizure-warning-lulw {
            height: 1em;
            width: auto;
            display: inline-block;
        }
        
        .song-info {
            position: relative;
        }
        
        .flying-lulw {
            position: fixed;
            top: 50%;
            left: -150vw;
            width: 80vw;
            height: 80vh;
            max-width: 800px;
            max-height: 800px;
            z-index: 100;
            transform: translateY(-50%);
            opacity: 0;
            transition: none;
            object-fit: contain;
        }
        
        @keyframes fly-across {
            0% {
                left: -150vw;
                opacity: 0.7;
                transform: translateY(-50%);
            }
            50% {
                opacity: 0.8;
                transform: translateY(-50%);
            }
            100% {
                left: 150vw;
                opacity: 0.7;
                transform: translateY(-50%);
            }
        }
        
        .flying-lulw.active {
            animation: fly-across 8s ease-in-out;
        }
        
        @media (max-width: 768px) {
            .flying-lulw {
                width: 90vw;
                height: 60vh;
                max-width: 400px;
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>hihomiedude</h1>
    </div>
    
    <!-- Song info below header -->
    <div class="song-info" id="songInfo">
        "clarity*" by "sennoh"
        <div class="progress-container">
            <div class="progress-line"></div>
            <div class="progress-dot" id="progressDot"></div>
        </div>
        <canvas id="visualizer" width="400" height="100"></canvas>
        <div class="seizure-warning" id="seizureWarning">
            <div id="seizureWarningText">SEIZURE WARNING (5)</div>
            <div class="seizure-warning-small" id="seizureWarningSmall" style="display: none;">
                <span>hihomiedude</span>
                <img src="assets/images/LULW.png" alt="LULW" class="seizure-warning-lulw">
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="side-image">
            <img src="assets/images/LULW.png" alt="LULW" class="lulw-img">
            <img src="assets/images/catJAM.gif" alt="catJAM" class="dancing-img" id="catJam">
        </div>
        
        <div class="center-box">
            <div class="play-section" id="playSection">
                <div class="play-button-container">
                    <button class="mute-button rainbow-text" id="muteBtn">[play]</button>
                </div>
            </div>
            
            <div class="audio-controls" id="audioControls" style="display: none;">
                <button class="mute-button rainbow-text" id="muteBtn2">[ pause ]</button>
            </div>
            
            <div class="link-item">
                <a href="https://twitch.tv/hihomiedude" class="twitch-link" target="_blank">twitch</a>
            </div>
            
            <div class="link-item">
                <a href="https://discord.gg/kz3c5U6U67" class="discord-link" target="_blank">discord</a>
            </div>
            
            <div class="link-item">
                <a href="https://myanimelist.net/animelist/hihomiedude?status=2&order=4&order2=0" class="anime-link" target="_blank">anime</a>
            </div>
            
            <div class="link-item">
                <a href="https://toneindicators.carrd.co/" class="tone-link" target="_blank">tone indicators</a>
            </div>
        </div>
        
        <div class="side-image">
            <img src="assets/images/LULW.png" alt="LULW" class="lulw-img">
            <img src="assets/images/ratJAM.gif" alt="ratJAM" class="dancing-img" id="ratJam">
        </div>
    </div>
    
    <audio id="bgMusic" loop>
        <source src="assets/audio/clarity.mp3" type="audio/mpeg">
    </audio>
    
    <div class="footer">
        this is a hihomiedude production
    </div>
    
    <img src="assets/images/LULW.png" alt="Flying LULW" class="flying-lulw" id="flyingLulw">
    
    <script>
        const audio = document.getElementById('bgMusic');
        const muteBtn = document.getElementById('muteBtn');
        const songInfo = document.getElementById('songInfo');
        let audioStarted = false;
        
        // Audio visualizer setup
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        let audioContext;
        let analyser;
        let source;
        let dataArray;
        const BPM = 134;
        
        // Bass detection variables
        let previousSpectrum = null;
        let fluxHistory = [];
        const FLUX_HISTORY_SIZE = 20; // Shorter history for faster adaptation
        const BASS_BINS = 4; // Focus only on deep bass frequencies
        const FLUX_THRESHOLD = 1.3; // Lower threshold for more sensitivity
        const MIN_FLUX = 0.08; // Much lower minimum flux for rapid hits
        
        // Time-based flash gating (start, end times in seconds)
        const FLASH_TIME_RANGES = [
            { start: 29.5, end: 43.5 },   // 0:29.5 - 0:43.5
            { start: 57, end: 72 },       // 0:57 - 1:12
            { start: 100.75, end: 115.5 }, // 1:40.75 - 1:55.5
            { start: 129, end: 999 }      // 2:09 - end of song
        ];
        
        // Seizure warning countdown
        const FIRST_FLASH_TIME = FLASH_TIME_RANGES[0].start;
        const WARNING_START_TIME = FIRST_FLASH_TIME - 5; // 5 seconds before
        let warningInterval = null;
        let warningShown = false;
        
        // Flying LULW timing - triggers during quiet periods
        const QUIET_PERIODS = [
            { start: FLASH_TIME_RANGES[0].end + 1, end: FLASH_TIME_RANGES[1].start - 1 }, // After 1st flash, before 2nd
            { start: FLASH_TIME_RANGES[1].end + 1, end: FLASH_TIME_RANGES[2].start - 1 }, // After 2nd flash, before 3rd
            { start: FLASH_TIME_RANGES[2].end + 1, end: FLASH_TIME_RANGES[3].start - 1 }  // After 3rd flash, before 4th
        ];
        let flyingLulwTriggers = [false, false, false]; // Track which quiet periods have triggered
        
        
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                analyser.fftSize = 2048;
                analyser.minDecibels = -70;
                analyser.maxDecibels = -10;
                analyser.smoothingTimeConstant = 0.8;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }
        }
        
        function showMusicElements() {
            songInfo.style.display = 'block';
            document.getElementById('catJam').classList.add('show');
            document.getElementById('ratJam').classList.add('show');
            // Start visualizer immediately
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            drawVisualizer();
        }
        
        function hideMusicElements() {
            songInfo.style.display = 'none';
            document.getElementById('catJam').classList.remove('show');
            document.getElementById('ratJam').classList.remove('show');
        }
        
        function flashBackground() {
            // Array of vaporwave/anime/chronically online colors
            const flashColors = [
                '#FF69B4', // Hot pink
                '#FF1493', // Deep pink
                '#FF00FF', // Magenta
                '#DA70D6', // Orchid
                '#BA55D3', // Medium orchid
                '#9370DB', // Medium purple
                '#00CED1', // Dark turquoise
                '#00FFFF', // Cyan
                '#40E0D0', // Turquoise
                '#7FFF00', // Chartreuse
                '#00FF00', // Lime green
                '#98FB98', // Pale green
                '#FFB6C1', // Light pink
                '#FFA0D2', // Bubblegum pink
                '#E0B0FF', // Mauve
                '#B19CD9', // Pastel purple
                '#87CEEB', // Sky blue
                '#ADD8E6', // Light blue
                '#FFFF00', // Yellow
                '#FFFFE0', // Light yellow
                '#98FF98', // Mint green
                '#FF6EC7', // Neon pink
                '#FF33CC', // Electric pink
                '#00FFCC', // Aqua
                '#33FF99', // Spring green
            ];
            
            // Pick random color from array
            const flashColor = flashColors[Math.floor(Math.random() * flashColors.length)];
            
            // Add vibrant glow effect
            document.body.style.backgroundColor = flashColor;
            document.body.style.boxShadow = `inset 0 0 80px ${flashColor}80, 0 0 120px ${flashColor}40`;
            document.body.style.transition = 'background-color 0.05s ease-out, box-shadow 0.05s ease-out';
            
            // Thump all images
            thumpImages();
            
            // Smoother fade back with easing
            setTimeout(() => {
                document.body.style.transition = 'background-color 0.3s ease-out, box-shadow 0.3s ease-out';
                document.body.style.backgroundColor = '#1a1a1a';
                document.body.style.boxShadow = 'none';
            }, 80);
        }
        
        function thumpImages() {
            const images = document.querySelectorAll('.lulw-img, .dancing-img');
            const sideBoxes = document.querySelectorAll('.side-image');
            
            // Array of colors different from the body flash colors
            const boxFlashColors = [
                '#00FF00', // Lime
                '#FF00FF', // Magenta
                '#00FFFF', // Cyan
                '#FFFF00', // Yellow
                '#FF1493', // Deep pink
                '#7FFF00', // Chartreuse
                '#FF69B4', // Hot pink
                '#00CED1', // Dark turquoise
                '#98FB98', // Pale green
                '#FFB6C1', // Light pink
                '#87CEEB', // Sky blue
                '#FF6EC7', // Neon pink
            ];
            
            images.forEach((img, index) => {
                // Remove any existing thump classes
                img.classList.remove('thump-up', 'thump-down');
                // Force reflow to restart animation
                img.offsetHeight;
                
                // Alternate direction: even indices go up, odd go down
                if (index % 2 === 0) {
                    img.classList.add('thump-up');
                } else {
                    img.classList.add('thump-down');
                }
            });
            
            // Flash side boxes with different colors
            sideBoxes.forEach((box) => {
                // Remove existing thump class
                box.classList.remove('side-image-thump');
                // Force reflow
                box.offsetHeight;
                
                // Pick random color for this box
                const boxColor = boxFlashColors[Math.floor(Math.random() * boxFlashColors.length)];
                box.style.backgroundColor = boxColor;
                box.classList.add('side-image-thump');
                
                // Reset after animation
                setTimeout(() => {
                    box.style.backgroundColor = '#2d2d2d';
                }, 250);
            });
        }
        
        function isFlashingAllowed() {
            const currentTime = audio.currentTime;
            return FLASH_TIME_RANGES.some(range => 
                currentTime >= range.start && currentTime <= range.end
            );
        }
        
        function startSeizureWarning() {
            const seizureWarning = document.getElementById('seizureWarning');
            seizureWarning.style.display = 'flex';
            let countdown = 5;
            
            const seizureWarningText = document.getElementById('seizureWarningText');
            seizureWarningText.textContent = `SEIZURE WARNING (${countdown})`;
            
            // Add click listener to pause music
            seizureWarning.addEventListener('click', pauseMusicFromWarning);
            
            warningInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    seizureWarningText.textContent = `SEIZURE WARNING (${countdown})`;
                    // Show hihomiedude LULW only on countdown 1
                    const seizureWarningSmall = document.getElementById('seizureWarningSmall');
                    if (countdown === 1) {
                        seizureWarningSmall.style.display = 'flex';
                    } else {
                        seizureWarningSmall.style.display = 'none';
                    }
                } else {
                    seizureWarning.style.display = 'none';
                    seizureWarning.removeEventListener('click', pauseMusicFromWarning);
                    clearInterval(warningInterval);
                    warningInterval = null;
                }
            }, 1000);
        }
        
        function pauseMusicFromWarning() {
            audio.pause();
            muteBtn.textContent = '[ play ]';
            hideMusicElements();
            stopSeizureWarning();
            
            // Show play section again and restore rainbow effect
            document.getElementById('playSection').style.display = 'block';
            muteBtn.classList.add('rainbow-text');
        }
        
        function stopSeizureWarning() {
            if (warningInterval) {
                clearInterval(warningInterval);
                warningInterval = null;
                const seizureWarning = document.getElementById('seizureWarning');
                seizureWarning.style.display = 'none';
                seizureWarning.removeEventListener('click', pauseMusicFromWarning);
            }
        }
        
        function checkSeizureWarning() {
            const currentTime = audio.currentTime;
            if (!warningShown && currentTime >= WARNING_START_TIME && currentTime < FIRST_FLASH_TIME) {
                startSeizureWarning();
                warningShown = true;
            }
        }
        
        function triggerFlyingLulw() {
            const flyingLulw = document.getElementById('flyingLulw');
            flyingLulw.classList.remove('active');
            // Force reflow to restart animation
            flyingLulw.offsetHeight;
            flyingLulw.classList.add('active');
            
            // Reset after animation completes
            setTimeout(() => {
                flyingLulw.classList.remove('active');
            }, 8000);
        }
        
        function checkFlyingLulw() {
            const currentTime = audio.currentTime;
            
            // Check each quiet period
            QUIET_PERIODS.forEach((period, index) => {
                if (!flyingLulwTriggers[index] && 
                    currentTime >= period.start && 
                    currentTime <= period.end) {
                    triggerFlyingLulw();
                    flyingLulwTriggers[index] = true;
                }
            });
        }
        
        function detectBassHit(dataArray) {
            if (!previousSpectrum) {
                previousSpectrum = new Float32Array(dataArray.length);
                return;
            }
            
            // Calculate overall volume level (RMS of all frequencies)
            let totalEnergy = 0;
            for (let i = 0; i < 64; i++) { // Check first 64 bins for overall volume
                totalEnergy += Math.pow(dataArray[i] / 255, 2);
            }
            const overallVolume = Math.sqrt(totalEnergy / 64);
            
            // Calculate spectral flux (sum of positive differences)
            let flux = 0;
            for (let i = 0; i < BASS_BINS; i++) {
                const current = dataArray[i] / 255;
                const previous = previousSpectrum[i];
                const diff = current - previous;
                
                // Only count positive differences (increases in energy)
                if (diff > 0) {
                    flux += diff;
                }
            }
            
            // During loud sections, also consider absolute bass level changes
            if (overallVolume > 0.5) { // Loud section
                // Calculate absolute bass energy
                let currentBassEnergy = 0;
                let previousBassEnergy = 0;
                for (let i = 0; i < BASS_BINS; i++) {
                    currentBassEnergy += Math.pow(dataArray[i] / 255, 2);
                    previousBassEnergy += Math.pow(previousSpectrum[i], 2);
                }
                
                // Add normalized bass energy change to flux
                const bassEnergyChange = Math.sqrt(currentBassEnergy) - Math.sqrt(previousBassEnergy);
                if (bassEnergyChange > 0) {
                    flux += bassEnergyChange * 0.5; // Weight it less than spectral flux
                }
            }
            
            // Store flux in history
            fluxHistory.push(flux);
            if (fluxHistory.length > FLUX_HISTORY_SIZE) {
                fluxHistory.shift();
            }
            
            // Need enough history
            if (fluxHistory.length < 10) {
                previousSpectrum = new Float32Array(dataArray).map(v => v / 255);
                return;
            }
            
            // Calculate average flux and recent flux for rapid succession detection
            const averageFlux = fluxHistory.reduce((a, b) => a + b, 0) / fluxHistory.length;
            const recentFlux = fluxHistory.slice(-3).reduce((a, b) => a + b, 0) / Math.min(3, fluxHistory.length);
            const immediateFlux = fluxHistory.slice(-2).reduce((a, b) => a + b, 0) / Math.min(2, fluxHistory.length);
            
            // Adjust sensitivity based on volume - more sensitive during loud sections
            const volumeMultiplier = overallVolume > 0.5 ? 0.7 : 1.0; // Lower threshold when loud
            
            // Use adaptive thresholds - much more sensitive for consecutive hits
            const baseThreshold = averageFlux * FLUX_THRESHOLD * volumeMultiplier;
            const rapidThreshold = recentFlux * 0.8 * volumeMultiplier; // Much more sensitive for recent hits
            const immediateThreshold = immediateFlux * 0.6 * volumeMultiplier; // Very sensitive for immediate succession
            const threshold = Math.max(Math.min(baseThreshold, Math.min(rapidThreshold, immediateThreshold)), MIN_FLUX * volumeMultiplier);
            
            // Detect beat if flux exceeds threshold AND bars 2-5 are pumping
            let bassSum = 0;
            const BASS_BARS_TO_CHECK = 4; // Bars 2-5 (indices 1-4)
            for (let i = 1; i < 5; i++) { // Skip leftmost bar (index 0)
                bassSum += dataArray[i] / 255;
            }
            const avgBassLevel = bassSum / BASS_BARS_TO_CHECK;
            
            // Lower bass level requirement during loud sections
            const bassLevelThreshold = overallVolume > 0.5 ? 0.25 : 0.35;
            
            // Additional validation: ensure actual bass content exists
            const maxBassValue = Math.max(dataArray[0], dataArray[1], dataArray[2], dataArray[3]) / 255;
            const hasSufficientBass = maxBassValue > 0.5; // At least one bass bin must be > 50%
            
            // Check for minimum flux change to avoid noise triggers
            const isSignificantFlux = flux > MIN_FLUX * 1.5; // Require 1.5x minimum for validation
            
            if (flux > threshold && flux > MIN_FLUX * volumeMultiplier && avgBassLevel > bassLevelThreshold && 
                hasSufficientBass && isSignificantFlux && isFlashingAllowed()) {
                flashBackground();
            }
            
            // Store current spectrum for next frame
            previousSpectrum = new Float32Array(dataArray).map(v => v / 255);
        }
        
        function drawVisualizer() {
            if (!analyser || audio.paused) return;
            
            requestAnimationFrame(drawVisualizer);
            
            analyser.getByteFrequencyData(dataArray);
            
            // Check for seizure warning
            checkSeizureWarning();
            
            // Check for flying LULW trigger
            checkFlyingLulw();
            
            // Detect bass hits for background flash
            detectBassHit(dataArray);
            
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Only show first 64 bins for better visualization
            const barsToShow = 64;
            const barWidth = canvas.width / barsToShow - 2;
            let x = 0;
            
            for (let i = 0; i < barsToShow; i++) {
                let value = dataArray[i];
                
                // Progressive frequency scaling - boost higher frequencies more
                const freqScaling = 1 + (i / barsToShow) * 1.5; // Scale from 1x to 2.5x
                value = value * freqScaling;
                
                // Additional bass boost for low frequencies
                if (i < 8) {
                    value = value * 1.2;  // Very low bass
                } else if (i < 16) {
                    value = value * 1.1;  // Mid bass
                }
                
                // Apply slight exponential scaling for smoother response
                value = Math.pow(value / 255, 1.5) * 255;
                
                // Always have minimum height of 10%, regardless of signal
                const normalizedValue = value / 255;
                const heightMultiplier = Math.max(normalizedValue, 0.1);
                
                const barHeight = heightMultiplier * canvas.height * 0.9;
                
                // Create gradient from green to orange to red
                const percent = barHeight / canvas.height;
                let r, g, b;
                
                if (percent < 0.5) {
                    // Green to orange
                    r = Math.floor(255 * (percent * 2));
                    g = 255;
                    b = 0;
                } else {
                    // Orange to red
                    r = 255;
                    g = Math.floor(255 * (2 - percent * 2));
                    b = 0;
                }
                
                ctx.fillStyle = `rgb(${r},${g},${b})`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 2;
            }
        }
        
        muteBtn.addEventListener('click', function() {
            if (!audioStarted || audio.paused) {
                // Initialize audio context first
                initAudioContext();
                
                // Start playing immediately
                audio.play().then(() => {
                    audioStarted = true;
                    
                    // Hide play section and show pause button
                    document.getElementById('playSection').style.display = 'none';
                    document.getElementById('audioControls').style.display = 'block';
                    
                    muteBtn.textContent = '[ pause ]';
                    muteBtn.style.backgroundColor = '#333';
                    muteBtn.classList.remove('rainbow-text');
                    
                    // Force audio context to resume and start visualizer immediately
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().then(() => {
                            showMusicElements();
                        });
                    } else {
                        showMusicElements();
                    }
                }).catch(() => {
                    muteBtn.textContent = '[ blocked ]';
                });
            } else {
                // Pause audio
                audio.pause();
                muteBtn.textContent = '[ play ]';
                hideMusicElements();
                stopSeizureWarning(); // Stop warning when pausing
                
                // Show play section again and hide pause button
                document.getElementById('playSection').style.display = 'block';
                document.getElementById('audioControls').style.display = 'none';
                muteBtn.classList.add('rainbow-text');
            }
        });
        
        // Update progress bar
        audio.addEventListener('timeupdate', function() {
            const progress = (audio.currentTime / audio.duration) * 100;
            if (!isNaN(progress)) {
                document.getElementById('progressDot').style.left = progress + '%';
            }
        });
        
        // Hide elements when audio ends
        audio.addEventListener('ended', function() {
            hideMusicElements();
            muteBtn.textContent = '[ play ]';
            document.getElementById('playSection').style.display = 'block';
            document.getElementById('audioControls').style.display = 'none';
            muteBtn.classList.add('rainbow-text');
        });
        
        // Second pause button functionality
        document.getElementById('muteBtn2').addEventListener('click', function() {
            audio.pause();
            muteBtn.textContent = '[ play ]';
            hideMusicElements();
            stopSeizureWarning();
            
            // Show play section again and hide pause button
            document.getElementById('playSection').style.display = 'block';
            document.getElementById('audioControls').style.display = 'none';
            muteBtn.classList.add('rainbow-text');
        });
    </script>
</body>
</html>
