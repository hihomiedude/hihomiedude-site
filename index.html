<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>hihomiedude</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            transition: background-color 0.3s ease-out;
        }
        
        .header {
            padding: 10px 20px;
            margin-bottom: 10px;
            background-color: #2d2d2d;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: normal;
        }
        
        /* Song info below header */
        .song-info {
            background-color: #2d2d2d;
            border: 2px solid #555;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
            position: relative;
        }
        
        .progress-container {
            position: relative;
            width: 100%;
            height: 20px;
            margin-top: 10px;
        }
        
        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #555;
            transform: translateY(-50%);
        }
        
        .progress-dot {
            position: absolute;
            top: 50%;
            left: 0%;
            width: 12px;
            height: 12px;
            background-color: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: left 0.1s linear;
        }
        
        #visualizer {
            display: block;
            margin: 15px auto 5px;
            background-color: #1a1a1a;
            border: 1px solid #444;
            max-width: 100%;
            height: auto;
        }
        
        .main-container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }
        
        .side-image {
            padding: 10px;
            background-color: #2d2d2d;
            min-width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 30px;
            overflow: visible;
        }
        
        .lulw-img {
            width: 100px;
            height: 100px;
            display: block;
        }
        
        .dancing-img {
            width: 100px;
            height: 100px;
            display: none;
        }
        
        .dancing-img.show {
            display: block;
        }
        
        
        .center-box {
            background-color: #2d2d2d;
            padding: 30px;
            flex: 1;
            min-height: 400px;
            text-align: center;
        }
        
        .link-item {
            margin: 40px 0;
            font-size: 18px;
        }
        
        .link-item a {
            color: #ffffff;
            text-decoration: none;
            border: 2px solid #555;
            padding: 8px 15px;
            background-color: #333;
            display: inline-block;
            transition: none;
        }
        
        .link-item a:hover {
            background-color: #444;
            border-color: #777;
        }
        
        .twitch-link {
            color: #9146ff !important;
        }
        
        .discord-link {
            color: #5865f2 !important;
        }
        
        .anime-link {
            color: #ff69b4 !important;
        }
        
        .tone-link {
            color: #ffd93d !important;
        }
        
        .audio-controls {
            margin-top: 20px;
        }
        
        .play-section {
            text-align: center;
            font-family: 'Courier New', monospace;
            margin-bottom: 15px;
        }
        
        .play-prompt {
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
        }
        
        .play-button-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mute-button {
            background-color: #333;
            color: white;
            border: 2px solid #555;
            padding: 12px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            font-size: 16px;
        }
        
        .mute-button:hover {
            background-color: #444;
            border-color: #777;
        }
        
        .rainbow-text {
            background: linear-gradient(90deg, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff00, #00ff80, #00ffff, #4da6ff, 
                #6699ff, #b366ff, #ff00ff, #ff0080, 
                #ff0000);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-cycle 3s linear infinite;
        }
        
        @keyframes rainbow-cycle {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }
        
        @keyframes bass-thump-up {
            0% {
                transform: scale(1) translateY(0);
                filter: brightness(1);
            }
            50% {
                transform: scale(1.6) translateY(-15px);
                filter: brightness(1.15);
            }
            100% {
                transform: scale(1) translateY(0);
                filter: brightness(1);
            }
        }
        
        @keyframes bass-thump-down {
            0% {
                transform: scale(1) translateY(0);
                filter: brightness(1);
            }
            50% {
                transform: scale(1.6) translateY(15px);
                filter: brightness(1.15);
            }
            100% {
                transform: scale(1) translateY(0);
                filter: brightness(1);
            }
        }
        
        .thump-up {
            animation: bass-thump-up 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .thump-down {
            animation: bass-thump-down 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .audio-controls {
            margin-top: 0;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .side-image:first-child {
                display: block;
                order: -1;
            }
            
            .side-image:last-child {
                display: none;
            }
            
            .side-image {
                padding: 8px;
                min-width: auto;
                gap: 10px;
            }
            
            .lulw-img {
                width: 80px;
                height: 80px;
                margin-bottom: 15px;
            }
            
            .dancing-img {
                width: 80px;
                height: 80px;
            }
            
            .center-box {
                padding: 20px;
                min-height: auto;
                width: 100%;
                max-width: 280px;
            }
            
            .link-item {
                margin: 20px 0;
            }
            
            .header {
                margin-bottom: 8px;
                padding: 8px 15px;
            }
            
            body {
                font-size: 14px;
                padding: 10px;
            }
            
            .song-info {
                padding: 8px;
                font-size: 12px;
                margin-bottom: 15px;
            }
        }
        
        .footer {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: 10px;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            border: 1px solid #444;
            padding: 5px 10px;
            background-color: #2d2d2d;
            z-index: -1;
        }
        
        .seizure-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
            font-size: 48px;
            font-weight: bold;
            color: #ffffff;
            text-align: center;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.75);
            border: 5px solid #ffffff;
            box-sizing: border-box;
            display: none;
            cursor: pointer;
        }
        
        .song-info {
            position: relative;
        }
        
        .flying-lulw {
            position: fixed;
            top: 50%;
            left: -300px;
            width: 250px;
            height: 250px;
            z-index: 100;
            transform: translateY(-50%);
            opacity: 0;
            transition: none;
        }
        
        @keyframes fly-across {
            0% {
                left: -300px;
                opacity: 1;
                transform: translateY(-50%) rotate(-10deg);
            }
            50% {
                transform: translateY(-50%) rotate(5deg);
            }
            100% {
                left: calc(100vw + 100px);
                opacity: 1;
                transform: translateY(-50%) rotate(-5deg);
            }
        }
        
        .flying-lulw.active {
            animation: fly-across 6s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>hihomiedude</h1>
    </div>
    
    <!-- Song info below header -->
    <div class="song-info" id="songInfo">
        "clarity*" by "sennoh"
        <div class="progress-container">
            <div class="progress-line"></div>
            <div class="progress-dot" id="progressDot"></div>
        </div>
        <canvas id="visualizer" width="400" height="100"></canvas>
        <div class="seizure-warning" id="seizureWarning">
            SEIZURE WARNING (5)
        </div>
    </div>
    
    <div class="main-container">
        <div class="side-image">
            <img src="assets/images/LULW.png" alt="LULW" class="lulw-img">
            <img src="assets/images/catJAM.gif" alt="catJAM" class="dancing-img" id="catJam">
        </div>
        
        <div class="center-box">
            <div class="play-section" id="playSection">
                <div class="play-button-container">
                    <button class="mute-button rainbow-text" id="muteBtn">[play]</button>
                </div>
            </div>
            
            <div class="link-item">
                <a href="https://twitch.tv/hihomiedude" class="twitch-link" target="_blank">twitch</a>
            </div>
            
            <div class="link-item">
                <a href="https://discord.gg/kz3c5U6U67" class="discord-link" target="_blank">discord</a>
            </div>
            
            <div class="link-item">
                <a href="https://myanimelist.net/animelist/hihomiedude?status=2&order=4&order2=0" class="anime-link" target="_blank">anime</a>
            </div>
            
            <div class="link-item">
                <a href="https://toneindicators.carrd.co/" class="tone-link" target="_blank">tone indicators</a>
            </div>
            
            <div class="audio-controls" id="audioControls" style="display: none;">
                <button class="mute-button" id="muteBtn2" style="display: none;">[pause]</button>
            </div>
        </div>
        
        <div class="side-image">
            <img src="assets/images/LULW.png" alt="LULW" class="lulw-img">
            <img src="assets/images/ratJAM.gif" alt="ratJAM" class="dancing-img" id="ratJam">
        </div>
    </div>
    
    <audio id="bgMusic" loop>
        <source src="assets/audio/clarity.mp3" type="audio/mpeg">
    </audio>
    
    <div class="footer">
        this is a hihomiedude production
    </div>
    
    <img src="assets/images/LULW.png" alt="Flying LULW" class="flying-lulw" id="flyingLulw">
    
    <script>
        const audio = document.getElementById('bgMusic');
        const muteBtn = document.getElementById('muteBtn');
        const songInfo = document.getElementById('songInfo');
        let audioStarted = false;
        
        // Audio visualizer setup
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        let audioContext;
        let analyser;
        let source;
        let dataArray;
        const BPM = 134;
        
        // Bass detection variables
        let previousSpectrum = null;
        let fluxHistory = [];
        const FLUX_HISTORY_SIZE = 20; // Shorter history for faster adaptation
        const BASS_BINS = 4; // Focus only on deep bass frequencies
        const FLUX_THRESHOLD = 1.6; // Lower threshold for more sensitivity
        const MIN_FLUX = 0.15; // Lower minimum flux for rapid hits
        
        // Time-based flash gating (start, end times in seconds)
        const FLASH_TIME_RANGES = [
            { start: 29.5, end: 43.5 },   // 0:29.5 - 0:43.5
            { start: 57, end: 72 },       // 0:57 - 1:12
            { start: 100.75, end: 115.5 }, // 1:40.75 - 1:55.5
            { start: 129, end: 999 }      // 2:09 - end of song
        ];
        
        // Seizure warning countdown
        const FIRST_FLASH_TIME = FLASH_TIME_RANGES[0].start;
        const WARNING_START_TIME = FIRST_FLASH_TIME - 5; // 5 seconds before
        let warningInterval = null;
        let warningShown = false;
        
        // Flying LULW timing
        const FLYING_LULW_TIME = FLASH_TIME_RANGES[0].end + 1; // 1 second after first flash period ends
        let flyingLulwShown = false;
        
        
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                analyser.fftSize = 2048;
                analyser.minDecibels = -70;
                analyser.maxDecibels = -10;
                analyser.smoothingTimeConstant = 0.8;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }
        }
        
        function showMusicElements() {
            songInfo.style.display = 'block';
            document.getElementById('catJam').classList.add('show');
            document.getElementById('ratJam').classList.add('show');
            // Start visualizer immediately
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            drawVisualizer();
        }
        
        function hideMusicElements() {
            songInfo.style.display = 'none';
            document.getElementById('catJam').classList.remove('show');
            document.getElementById('ratJam').classList.remove('show');
        }
        
        function flashBackground() {
            // Generate random grayscale intensity for variety
            const intensity = Math.random() * 0.3 + 0.5; // 50-80% intensity
            const grayValue = Math.floor(255 * intensity);
            const flashColor = `rgb(${grayValue}, ${grayValue}, ${grayValue})`;
            
            // Add subtle glow effect
            document.body.style.backgroundColor = flashColor;
            document.body.style.boxShadow = `inset 0 0 50px rgba(255, 255, 255, ${intensity * 0.3})`;
            document.body.style.transition = 'background-color 0.05s ease-out, box-shadow 0.05s ease-out';
            
            // Thump all images
            thumpImages();
            
            // Smoother fade back with easing
            setTimeout(() => {
                document.body.style.transition = 'background-color 0.3s ease-out, box-shadow 0.3s ease-out';
                document.body.style.backgroundColor = '#1a1a1a';
                document.body.style.boxShadow = 'none';
            }, 80);
        }
        
        function thumpImages() {
            const images = document.querySelectorAll('.lulw-img, .dancing-img');
            
            images.forEach((img, index) => {
                // Remove any existing thump classes
                img.classList.remove('thump-up', 'thump-down');
                // Force reflow to restart animation
                img.offsetHeight;
                
                // Alternate direction: even indices go up, odd go down
                if (index % 2 === 0) {
                    img.classList.add('thump-up');
                } else {
                    img.classList.add('thump-down');
                }
            });
        }
        
        function isFlashingAllowed() {
            const currentTime = audio.currentTime;
            return FLASH_TIME_RANGES.some(range => 
                currentTime >= range.start && currentTime <= range.end
            );
        }
        
        function startSeizureWarning() {
            const seizureWarning = document.getElementById('seizureWarning');
            seizureWarning.style.display = 'flex';
            let countdown = 5;
            
            seizureWarning.textContent = `SEIZURE WARNING (${countdown})`;
            
            // Add click listener to pause music
            seizureWarning.addEventListener('click', pauseMusicFromWarning);
            
            warningInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    seizureWarning.textContent = `SEIZURE WARNING (${countdown})`;
                } else {
                    seizureWarning.style.display = 'none';
                    seizureWarning.removeEventListener('click', pauseMusicFromWarning);
                    clearInterval(warningInterval);
                    warningInterval = null;
                }
            }, 1000);
        }
        
        function pauseMusicFromWarning() {
            audio.pause();
            muteBtn.textContent = '[play]';
            hideMusicElements();
            stopSeizureWarning();
            
            // Show play section again and restore rainbow effect
            document.getElementById('playSection').style.display = 'block';
            muteBtn.classList.add('rainbow-text');
        }
        
        function stopSeizureWarning() {
            if (warningInterval) {
                clearInterval(warningInterval);
                warningInterval = null;
                const seizureWarning = document.getElementById('seizureWarning');
                seizureWarning.style.display = 'none';
                seizureWarning.removeEventListener('click', pauseMusicFromWarning);
            }
        }
        
        function checkSeizureWarning() {
            const currentTime = audio.currentTime;
            if (!warningShown && currentTime >= WARNING_START_TIME && currentTime < FIRST_FLASH_TIME) {
                startSeizureWarning();
                warningShown = true;
            }
        }
        
        function triggerFlyingLulw() {
            const flyingLulw = document.getElementById('flyingLulw');
            flyingLulw.classList.remove('active');
            // Force reflow to restart animation
            flyingLulw.offsetHeight;
            flyingLulw.classList.add('active');
            
            // Reset for potential future triggers (if song loops)
            setTimeout(() => {
                flyingLulw.classList.remove('active');
            }, 6000);
        }
        
        function checkFlyingLulw() {
            const currentTime = audio.currentTime;
            if (!flyingLulwShown && currentTime >= FLYING_LULW_TIME) {
                triggerFlyingLulw();
                flyingLulwShown = true;
            }
        }
        
        function detectBassHit(dataArray) {
            if (!previousSpectrum) {
                previousSpectrum = new Float32Array(dataArray.length);
                return;
            }
            
            // Calculate spectral flux (sum of positive differences)
            let flux = 0;
            for (let i = 0; i < BASS_BINS; i++) {
                const current = dataArray[i] / 255;
                const previous = previousSpectrum[i];
                const diff = current - previous;
                
                // Only count positive differences (increases in energy)
                if (diff > 0) {
                    flux += diff;
                }
            }
            
            // Remove mid frequency detection - focus only on bass
            
            // Store flux in history
            fluxHistory.push(flux);
            if (fluxHistory.length > FLUX_HISTORY_SIZE) {
                fluxHistory.shift();
            }
            
            // Need enough history
            if (fluxHistory.length < 10) {
                previousSpectrum = new Float32Array(dataArray).map(v => v / 255);
                return;
            }
            
            // Calculate average flux and recent flux for rapid succession detection
            const averageFlux = fluxHistory.reduce((a, b) => a + b, 0) / fluxHistory.length;
            const recentFlux = fluxHistory.slice(-5).reduce((a, b) => a + b, 0) / Math.min(5, fluxHistory.length);
            
            // Use lower of the two thresholds to catch rapid hits
            const baseThreshold = averageFlux * FLUX_THRESHOLD;
            const rapidThreshold = recentFlux * 1.2; // Much more sensitive for rapid succession
            const threshold = Math.max(Math.min(baseThreshold, rapidThreshold), MIN_FLUX);
            
            // Detect beat if flux exceeds threshold AND bars 2-5 are pumping
            let bassSum = 0;
            const BASS_BARS_TO_CHECK = 4; // Bars 2-5 (indices 1-4)
            for (let i = 1; i < 5; i++) { // Skip leftmost bar (index 0)
                bassSum += dataArray[i] / 255;
            }
            const avgBassLevel = bassSum / BASS_BARS_TO_CHECK;
            
            if (flux > threshold && flux > MIN_FLUX && avgBassLevel > 0.45 && isFlashingAllowed()) {
                flashBackground();
            }
            
            // Store current spectrum for next frame
            previousSpectrum = new Float32Array(dataArray).map(v => v / 255);
        }
        
        function drawVisualizer() {
            if (!analyser || audio.paused) return;
            
            requestAnimationFrame(drawVisualizer);
            
            analyser.getByteFrequencyData(dataArray);
            
            // Check for seizure warning
            checkSeizureWarning();
            
            // Check for flying LULW trigger
            checkFlyingLulw();
            
            // Detect bass hits for background flash
            detectBassHit(dataArray);
            
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Only show first 64 bins for better visualization
            const barsToShow = 64;
            const barWidth = canvas.width / barsToShow - 2;
            let x = 0;
            
            for (let i = 0; i < barsToShow; i++) {
                let value = dataArray[i];
                
                // Progressive frequency scaling - boost higher frequencies more
                const freqScaling = 1 + (i / barsToShow) * 1.5; // Scale from 1x to 2.5x
                value = value * freqScaling;
                
                // Additional bass boost for low frequencies
                if (i < 8) {
                    value = value * 1.2;  // Very low bass
                } else if (i < 16) {
                    value = value * 1.1;  // Mid bass
                }
                
                // Apply slight exponential scaling for smoother response
                value = Math.pow(value / 255, 1.5) * 255;
                
                // Always have minimum height of 10%, regardless of signal
                const normalizedValue = value / 255;
                const heightMultiplier = Math.max(normalizedValue, 0.1);
                
                const barHeight = heightMultiplier * canvas.height * 0.9;
                
                // Create gradient from green to orange to red
                const percent = barHeight / canvas.height;
                let r, g, b;
                
                if (percent < 0.5) {
                    // Green to orange
                    r = Math.floor(255 * (percent * 2));
                    g = 255;
                    b = 0;
                } else {
                    // Orange to red
                    r = 255;
                    g = Math.floor(255 * (2 - percent * 2));
                    b = 0;
                }
                
                ctx.fillStyle = `rgb(${r},${g},${b})`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 2;
            }
        }
        
        muteBtn.addEventListener('click', function() {
            if (!audioStarted || audio.paused) {
                // Initialize audio context first
                initAudioContext();
                
                // Start playing immediately
                audio.play().then(() => {
                    audioStarted = true;
                    
                    // Hide play section
                    document.getElementById('playSection').style.display = 'none';
                    
                    muteBtn.textContent = '[pause]';
                    muteBtn.style.backgroundColor = '#333';
                    muteBtn.classList.remove('rainbow-text');
                    
                    // Force audio context to resume and start visualizer immediately
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().then(() => {
                            showMusicElements();
                        });
                    } else {
                        showMusicElements();
                    }
                }).catch(() => {
                    muteBtn.textContent = '[blocked]';
                });
            } else {
                // Pause audio
                audio.pause();
                muteBtn.textContent = '[play]';
                hideMusicElements();
                stopSeizureWarning(); // Stop warning when pausing
                
                // Show play section again and restore rainbow effect
                document.getElementById('playSection').style.display = 'block';
                muteBtn.classList.add('rainbow-text');
            }
        });
        
        // Update progress bar
        audio.addEventListener('timeupdate', function() {
            const progress = (audio.currentTime / audio.duration) * 100;
            if (!isNaN(progress)) {
                document.getElementById('progressDot').style.left = progress + '%';
            }
        });
        
        // Hide elements when audio ends
        audio.addEventListener('ended', function() {
            hideMusicElements();
            muteBtn.textContent = '[play]';
        });
    </script>
</body>
</html>
